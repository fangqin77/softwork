import{d as G,n as H,r as c,j as p,p as J,o as K,q as O,c as o,a as e,k as d,t as i,x as A,u as P,z as Q,F as W,h as X,s as v,y as Y,i as n,l as Z,f as tt,A as et,_ as st}from"./index-aoWYAbzc.js";const at={class:"activity-detail"},lt={key:0,class:"loading"},ot={key:1,class:"activity-content"},nt={class:"activity-header"},it=["src","alt"],rt={class:"activity-basic-info"},ut={class:"activity-meta"},ct={class:"meta-item"},dt={class:"value"},vt={class:"meta-item"},pt={class:"value"},_t={class:"meta-item"},mt={class:"value"},yt={class:"meta-item"},bt={class:"value"},ft={class:"meta-item"},gt={class:"action-buttons"},ht={key:2,class:"btn btn-success",disabled:""},wt={key:3,class:"btn btn-disabled",disabled:""},kt={class:"activity-details"},Ct={class:"detail-section"},qt={class:"description"},St={key:0,class:"detail-section"},$t=["src","alt"],Ut={class:"club-text"},xt={class:"detail-section"},Dt={class:"sign-up-stats"},At={class:"stat-item"},Ft={class:"stat-value"},Vt={key:0,class:"stat-item"},Nt={class:"stat-value"},zt={key:1,class:"detail-section admin-section"},Bt={class:"admin-actions"},Lt={key:0,class:"modal-overlay"},Mt={class:"modal-content"},It={class:"modal-header"},Rt={class:"modal-body"},Tt=["for"],jt={key:0,class:"required"},Et=["id","onUpdate:modelValue","type","required","placeholder"],Gt={class:"form-actions"},Ht=["disabled"],Jt={key:2,class:"not-found"},Kt=G({__name:"ActivityDetail",setup(Ot){const q=J(),F=Y(),r=H(),a=c(null),u=c(null),m=c([]),g=c([]),h=c(!0),y=c(!1),b=c(!1),f=c({}),_=p(()=>q.params.id),V=p(()=>{var s;return((s=a.value)==null?void 0:s.custom_form_fields)||[]}),N=p(()=>!r.user||!u.value?!1:r.user.role==="club_admin"),w=p(()=>m.value.some(s=>s.target_type==="activity"&&s.target_id===_.value)),S=p(()=>r.user?g.value.some(s=>{var t;return s.user_id===((t=r.user)==null?void 0:t.id)}):!1),k=p(()=>g.value.length),z=p(()=>!(!r.user||!a.value||S.value||a.value.status==="cancelled"||new Date(a.value.sign_up_deadline)<new Date||a.value.max_people&&k.value>=a.value.max_people)),B=s=>({pending:"待开始",ongoing:"进行中",completed:"已完成",cancelled:"已取消"})[s]||s,L=s=>({pending:"pending",ongoing:"ongoing",completed:"completed",cancelled:"cancelled"})[s]||"",M=s=>s||"text",$=s=>new Date(s).toLocaleString("zh-CN"),U=async()=>{try{h.value=!0;const{data:s,error:t}=await v.from("activities").select("*").eq("id",_.value).single();if(t)throw t;a.value=s,s&&await I(s.club_id)}catch(s){console.error("获取活动详情失败:",s),a.value=null}finally{h.value=!1}},I=async s=>{try{const{data:t,error:l}=await v.from("clubs").select("*").eq("id",s).single();if(l)throw l;u.value=t}catch(t){console.error("获取社团信息失败:",t)}},C=async()=>{try{const{data:s,error:t}=await v.from("activity_sign_ups").select("*").eq("activity_id",_.value);if(t)throw t;g.value=s||[]}catch(s){console.error("获取报名列表失败:",s)}},x=async()=>{if(r.user)try{const{data:s,error:t}=await v.from("collections").select("*").eq("user_id",r.user.id);if(t)throw t;m.value=s||[]}catch(s){console.error("获取收藏列表失败:",s)}},R=async()=>{if(!r.user){F.push("/login");return}try{if(w.value){const{error:s}=await v.from("collections").delete().eq("user_id",r.user.id).eq("target_type","activity").eq("target_id",_.value);if(s)throw s;m.value=m.value.filter(t=>!(t.target_type==="activity"&&t.target_id===_.value))}else{const{data:s,error:t}=await v.from("collections").insert({user_id:r.user.id,target_type:"activity",target_id:_.value}).select().single();if(t)throw t;m.value.push(s)}}catch(s){console.error("操作收藏失败:",s)}},T=async()=>{if(!(!r.user||!a.value))try{b.value=!0;const{error:s}=await v.from("activity_sign_ups").insert({activity_id:a.value.id,user_id:r.user.id,form_data:f.value});if(s)throw s;y.value=!1,f.value={},await C(),alert("报名成功！")}catch(s){console.error("报名失败:",s),alert("报名失败，请重试")}finally{b.value=!1}},j=async()=>{console.log("导出报名名单")},D=async s=>{if(a.value)try{const{error:t}=await v.from("activities").update({status:s}).eq("id",a.value.id);if(t)throw t;a.value.status=s,alert("活动状态更新成功")}catch(t){console.error("更新活动状态失败:",t),alert("更新失败，请重试")}};return K(async()=>{await U(),a.value&&(await C(),await x())}),O(()=>q.params.id,async()=>{await U(),a.value&&(await C(),await x())}),(s,t)=>(n(),o("div",at,[h.value?(n(),o("div",lt,"加载中...")):a.value?(n(),o("div",ot,[e("div",nt,[e("img",{src:a.value.poster_url,alt:a.value.title,class:"activity-poster"},null,8,it),e("div",rt,[e("h1",null,i(a.value.title),1),e("div",ut,[e("div",ct,[t[8]||(t[8]=e("span",{class:"label"},"活动时间:",-1)),e("span",dt,i($(a.value.activity_time)),1)]),e("div",vt,[t[9]||(t[9]=e("span",{class:"label"},"活动地点:",-1)),e("span",pt,i(a.value.location),1)]),e("div",_t,[t[10]||(t[10]=e("span",{class:"label"},"报名截止:",-1)),e("span",mt,i($(a.value.sign_up_deadline)),1)]),e("div",yt,[t[11]||(t[11]=e("span",{class:"label"},"人数限制:",-1)),e("span",bt,i(a.value.max_people||"无限制"),1)]),e("div",ft,[t[12]||(t[12]=e("span",{class:"label"},"活动状态:",-1)),e("span",{class:A(["value status",L(a.value.status)])},i(B(a.value.status)),3)])]),e("div",gt,[P(r).user?(n(),o("button",{key:0,onClick:R,class:A(["btn","btn-secondary",{collected:w.value}])},i(w.value?"已收藏":"收藏活动"),3)):d("",!0),z.value?(n(),o("button",{key:1,onClick:t[0]||(t[0]=l=>y.value=!0),class:"btn btn-primary"}," 立即报名 ")):S.value?(n(),o("button",ht," 已报名 ")):(n(),o("button",wt," 无法报名 "))])])]),e("div",kt,[e("div",Ct,[t[13]||(t[13]=e("h3",null,"活动描述",-1)),e("p",qt,i(a.value.description),1)]),u.value?(n(),o("div",St,[t[14]||(t[14]=e("h3",null,"所属社团",-1)),e("div",{class:"club-info",onClick:t[1]||(t[1]=l=>s.$router.push(`/clubs/${u.value.id}`))},[e("img",{src:u.value.logo_url,alt:u.value.name,class:"club-logo"},null,8,$t),e("div",Ut,[e("h4",null,i(u.value.name),1),e("p",null,i(u.value.intro),1)])])])):d("",!0),e("div",xt,[t[17]||(t[17]=e("h3",null,"报名情况",-1)),e("div",Dt,[e("div",At,[t[15]||(t[15]=e("span",{class:"stat-label"},"已报名人数:",-1)),e("span",Ft,i(k.value),1)]),a.value.max_people?(n(),o("div",Vt,[t[16]||(t[16]=e("span",{class:"stat-label"},"剩余名额:",-1)),e("span",Nt,i(a.value.max_people-k.value),1)])):d("",!0)])]),N.value?(n(),o("div",zt,[t[18]||(t[18]=e("h3",null,"活动管理",-1)),e("div",Bt,[e("button",{onClick:t[2]||(t[2]=l=>s.$router.push(`/activities/${a.value.id}/edit`)),class:"btn btn-primary"}," 编辑活动 "),e("button",{onClick:j,class:"btn btn-secondary"}," 导出报名名单 "),a.value.status==="pending"?(n(),o("button",{key:0,onClick:t[3]||(t[3]=l=>D("ongoing")),class:"btn btn-warning"}," 开始活动 ")):d("",!0),a.value.status==="ongoing"?(n(),o("button",{key:1,onClick:t[4]||(t[4]=l=>D("completed")),class:"btn btn-success"}," 结束活动 ")):d("",!0)])])):d("",!0)]),y.value?(n(),o("div",Lt,[e("div",Mt,[e("div",It,[e("h3",null,"报名 "+i(a.value.title),1),e("button",{onClick:t[5]||(t[5]=l=>y.value=!1),class:"close-btn"},"×")]),e("div",Rt,[e("form",{onSubmit:Q(T,["prevent"])},[(n(!0),o(W,null,X(V.value,l=>(n(),o("div",{key:l.name,class:"form-field"},[e("label",{for:l.name},[tt(i(l.label||l.name)+" ",1),l.required?(n(),o("span",jt,"*")):d("",!0)],8,Tt),Z(e("input",{id:l.name,"onUpdate:modelValue":E=>f.value[l.name]=E,type:M(l.type),required:l.required,placeholder:l.placeholder||`请输入${l.label||l.name}`},null,8,Et),[[et,f.value[l.name]]])]))),128)),e("div",Gt,[e("button",{type:"button",onClick:t[6]||(t[6]=l=>y.value=!1),class:"btn btn-secondary"}," 取消 "),e("button",{type:"submit",class:"btn btn-primary",disabled:b.value},i(b.value?"报名中...":"确认报名"),9,Ht)])],32)])])])):d("",!0)])):(n(),o("div",Jt,[t[19]||(t[19]=e("h2",null,"活动不存在",-1)),e("button",{onClick:t[7]||(t[7]=l=>s.$router.push("/")),class:"btn btn-primary"},"返回首页")]))]))}}),Qt=st(Kt,[["__scopeId","data-v-b9ded5f2"]]);export{Qt as default};
