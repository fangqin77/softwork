import{d as U,n as W,r as c,o as j,c as a,u as v,a as e,k as m,t as r,x as f,F as D,h as L,z as b,l as V,v as F,s as _,y as G,i as o,_ as H}from"./index-aoWYAbzc.js";const J={class:"profile-page"},K={key:0,class:"not-logged-in"},Q={key:1,class:"profile-content"},X={class:"user-card"},Y={class:"user-header"},Z=["src","alt"],ee={class:"user-info"},te={class:"role"},se={class:"college"},le={class:"tabs"},ae={key:0,class:"tab-content"},oe={key:0,class:"loading"},ie={key:1,class:"empty-state"},ne={key:2,class:"sign-ups-list"},re=["onClick"],ue=["src","alt"],ce={class:"sign-up-info"},de={class:"activity-time"},ve={class:"activity-location"},_e={class:"sign-up-time"},pe={key:1,class:"tab-content"},ye={key:0,class:"loading"},me={key:1,class:"empty-state"},ge={key:2,class:"collections-grid"},fe=["onClick"],be={key:0,class:"collection-club"},he=["src","alt"],ke={class:"collection-info"},Ce={key:1,class:"collection-activity"},$e=["src","alt"],we={class:"collection-info"},Se=["onClick"],qe={key:2,class:"tab-content"},De={key:0,class:"loading"},Le={key:1,class:"empty-state"},Ve={key:2,class:"admin-clubs"},Fe=["onClick"],Pe=["src","alt"],ze={class:"club-info"},Be={class:"club-actions"},Me=["onClick"],Ne=["onClick"],Ee={key:3,class:"modal-overlay"},Ie={class:"modal-content"},Te={class:"modal-header"},xe={class:"modal-body"},Ae={class:"form-field"},Oe={class:"form-field"},Re={class:"form-field"},Ue={class:"form-actions"},We=["disabled"],je=U({__name:"Profile",setup(Ge){var z,B,M;const P=G(),i=W(),d=c("signups"),p=c(!1),g=c(!1),h=c(!1),k=c(!1),C=c(!1),$=c([]),y=c([]),w=c([]),u=c({username:((z=i.user)==null?void 0:z.username)||"",college:((B=i.user)==null?void 0:B.college)||"",grade:((M=i.user)==null?void 0:M.grade)||""}),N=l=>({pending:"待开始",ongoing:"进行中",completed:"已完成",cancelled:"已取消"})[l]||l,E=l=>({pending:"pending",ongoing:"ongoing",completed:"completed",cancelled:"cancelled"})[l]||"",S=l=>new Date(l).toLocaleString("zh-CN"),I=async()=>{if(i.user)try{h.value=!0;const{data:l,error:t}=await _.from("activity_sign_ups").select(`
        *,
        activity:activities(*)
      `).eq("user_id",i.user.id).order("created_at",{ascending:!1});if(t)throw t;$.value=l||[]}catch(l){console.error("获取报名记录失败:",l)}finally{h.value=!1}},T=async()=>{if(i.user)try{k.value=!0;const{data:l,error:t}=await _.from("collections").select("*").eq("user_id",i.user.id).order("created_at",{ascending:!1});if(t)throw t;const s=await Promise.all((l||[]).map(async n=>{if(n.target_type==="club"){const{data:q}=await _.from("clubs").select("*").eq("id",n.target_id).single();return{...n,club:q}}else{const{data:q}=await _.from("activities").select("*").eq("id",n.target_id).single();return{...n,activity:q}}}));y.value=s.filter(n=>n.target_type==="club"&&n.club||n.target_type==="activity"&&n.activity)}catch(l){console.error("获取收藏列表失败:",l)}finally{k.value=!1}},x=async()=>{if(i.user)try{C.value=!0;const{data:l,error:t}=await _.from("clubs").select("*").eq("status","active").order("created_at",{ascending:!1});if(t)throw t;w.value=l||[]}catch(l){console.error("获取管理社团失败:",l)}finally{C.value=!1}},A=l=>{l.target_type==="club"?P.push(`/clubs/${l.target_id}`):P.push(`/activities/${l.target_id}`)},O=async l=>{try{const{error:t}=await _.from("collections").delete().eq("id",l.id);if(t)throw t;y.value=y.value.filter(s=>s.id!==l.id)}catch(t){console.error("取消收藏失败:",t)}},R=async()=>{if(i.user)try{g.value=!0;const{error:l}=await _.from("profiles").update({username:u.value.username,college:u.value.college,grade:u.value.grade,updated_at:new Date().toISOString()}).eq("id",i.user.id);if(l)throw l;i.setUser({...i.user,username:u.value.username,college:u.value.college,grade:u.value.grade}),p.value=!1,alert("资料更新成功")}catch(l){console.error("更新资料失败:",l),alert("更新失败，请重试")}finally{g.value=!1}};return j(async()=>{i.user&&(await I(),await T(),i.user.role==="club_admin"&&await x())}),(l,t)=>(o(),a("div",J,[v(i).user?(o(),a("div",Q,[e("div",X,[e("div",Y,[e("img",{src:v(i).user.avatar_url,alt:v(i).user.username,class:"avatar"},null,8,Z),e("div",ee,[e("h2",null,r(v(i).user.username),1),e("p",te,r(v(i).user.role==="student"?"学生":"社团管理员"),1),e("p",se,r(v(i).user.college)+" - "+r(v(i).user.grade),1)]),e("button",{onClick:t[1]||(t[1]=s=>p.value=!0),class:"btn btn-outline"},"编辑资料")])]),e("div",le,[e("button",{class:f(["tab",{active:d.value==="signups"}]),onClick:t[2]||(t[2]=s=>d.value="signups")}," 我的报名 ",2),e("button",{class:f(["tab",{active:d.value==="collections"}]),onClick:t[3]||(t[3]=s=>d.value="collections")}," 我的收藏 ",2),v(i).user.role==="club_admin"?(o(),a("button",{key:0,class:f(["tab",{active:d.value==="admin"}]),onClick:t[4]||(t[4]=s=>d.value="admin")}," 社团管理 ",2)):m("",!0)]),d.value==="signups"?(o(),a("div",ae,[h.value?(o(),a("div",oe,"加载中...")):$.value.length===0?(o(),a("div",ie,[t[13]||(t[13]=e("p",null,"暂无报名记录",-1)),e("button",{onClick:t[5]||(t[5]=s=>l.$router.push("/")),class:"btn btn-primary"},"去发现活动")])):(o(),a("div",ne,[(o(!0),a(D,null,L($.value,s=>(o(),a("div",{key:s.id,class:"sign-up-item",onClick:n=>l.$router.push(`/activities/${s.activity.id}`)},[e("img",{src:s.activity.poster_url,alt:s.activity.title,class:"activity-poster"},null,8,ue),e("div",ce,[e("h4",null,r(s.activity.title),1),e("p",de,r(S(s.activity.activity_time)),1),e("p",ve,r(s.activity.location),1),e("p",_e,"报名时间: "+r(S(s.created_at)),1),e("p",{class:f(["status",E(s.activity.status)])},r(N(s.activity.status)),3)])],8,re))),128))]))])):m("",!0),d.value==="collections"?(o(),a("div",pe,[k.value?(o(),a("div",ye,"加载中...")):y.value.length===0?(o(),a("div",me,[...t[14]||(t[14]=[e("p",null,"暂无收藏",-1)])])):(o(),a("div",ge,[(o(!0),a(D,null,L(y.value,s=>(o(),a("div",{key:s.id,class:"collection-item",onClick:n=>A(s)},[s.target_type==="club"?(o(),a("div",be,[e("img",{src:s.club.logo_url,alt:s.club.name,class:"collection-image"},null,8,he),e("div",ke,[e("h4",null,r(s.club.name),1),e("p",null,r(s.club.intro),1),t[15]||(t[15]=e("span",{class:"collection-type"},"社团",-1))])])):(o(),a("div",Ce,[e("img",{src:s.activity.poster_url,alt:s.activity.title,class:"collection-image"},null,8,$e),e("div",we,[e("h4",null,r(s.activity.title),1),e("p",null,r(S(s.activity.activity_time)),1),t[16]||(t[16]=e("span",{class:"collection-type"},"活动",-1))])])),e("button",{onClick:b(n=>O(s),["stop"]),class:"remove-btn"},"取消收藏",8,Se)],8,fe))),128))]))])):m("",!0),d.value==="admin"?(o(),a("div",qe,[C.value?(o(),a("div",De,"加载中...")):w.value.length===0?(o(),a("div",Le,[t[17]||(t[17]=e("p",null,"您还没有管理的社团",-1)),e("button",{onClick:t[6]||(t[6]=s=>l.$router.push("/clubs/create")),class:"btn btn-primary"},"创建社团")])):(o(),a("div",Ve,[(o(!0),a(D,null,L(w.value,s=>(o(),a("div",{key:s.id,class:"admin-club-item",onClick:n=>l.$router.push(`/clubs/${s.id}`)},[e("img",{src:s.logo_url,alt:s.name,class:"club-logo"},null,8,Pe),e("div",ze,[e("h4",null,r(s.name),1),e("p",null,r(s.intro),1)]),e("div",Be,[e("button",{onClick:b(n=>l.$router.push(`/activities/create?club=${s.id}`),["stop"]),class:"btn btn-primary"}," 发布活动 ",8,Me),e("button",{onClick:b(n=>l.$router.push(`/clubs/${s.id}/edit`),["stop"]),class:"btn btn-secondary"}," 编辑社团 ",8,Ne)])],8,Fe))),128))]))])):m("",!0),p.value?(o(),a("div",Ee,[e("div",Ie,[e("div",Te,[t[18]||(t[18]=e("h3",null,"编辑资料",-1)),e("button",{onClick:t[7]||(t[7]=s=>p.value=!1),class:"close-btn"},"×")]),e("div",xe,[e("form",{onSubmit:b(R,["prevent"])},[e("div",Ae,[t[19]||(t[19]=e("label",{for:"username"},"昵称",-1)),V(e("input",{id:"username","onUpdate:modelValue":t[8]||(t[8]=s=>u.value.username=s),type:"text",required:"",placeholder:"请输入昵称"},null,512),[[F,u.value.username]])]),e("div",Oe,[t[20]||(t[20]=e("label",{for:"college"},"学院",-1)),V(e("input",{id:"college","onUpdate:modelValue":t[9]||(t[9]=s=>u.value.college=s),type:"text",required:"",placeholder:"请输入学院"},null,512),[[F,u.value.college]])]),e("div",Re,[t[21]||(t[21]=e("label",{for:"grade"},"年级",-1)),V(e("input",{id:"grade","onUpdate:modelValue":t[10]||(t[10]=s=>u.value.grade=s),type:"text",required:"",placeholder:"请输入年级"},null,512),[[F,u.value.grade]])]),e("div",Ue,[e("button",{type:"button",onClick:t[11]||(t[11]=s=>p.value=!1),class:"btn btn-secondary"}," 取消 "),e("button",{type:"submit",class:"btn btn-primary",disabled:g.value},r(g.value?"更新中...":"保存"),9,We)])],32)])])])):m("",!0)])):(o(),a("div",K,[t[12]||(t[12]=e("p",null,"请先登录",-1)),e("button",{onClick:t[0]||(t[0]=s=>l.$router.push("/login")),class:"btn btn-primary"},"去登录")]))]))}}),Je=H(je,[["__scopeId","data-v-7ef6015a"]]);export{Je as default};
